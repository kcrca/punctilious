<!-- styles -->
<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<style>
  button.right {
  float: right;
  }
</style>

<!-- content -->
<form id="prefs">
<div class="block">
  <? for (var i = 0; i < fixes.length; i++) { ?>
  <?   var f = fixes[i]; ?>
  <input class="pref" type="checkbox" name="fix" value="<?= f.name ?>" id="pref-<?= f.name ?>">
  <label><?= f.desc ?></label><br>
  <? } ?>
  <textarea class="pref" name="<?= ignoredFontsName ?>" id="<?= ignoredFontsName ?>" rows="3" style="left-indent: 3em; width: 100%"
            onchange="updateSaveButton()"></textarea>
</div>
</form>
<div class="button-bar">
  <button id="ok" class="action">OK</button>
  <button>Cancel</button>
</div>
<div class="button-bar-right">
  <button id="save-default" onclick="saveDefault()">Save as defaults</button>
</div>

<!-- scripts -->
<script>
<? for (var i in exports) { ?>
<?   var v = exports[i]; ?>
<?   if (true) { ?>
var <?!=v?> = <?!=JSON.stringify(eval(v));?>;
<?   } ?>
<? } ?>

$("input.pref").each(function(index) {
  var $this = $(this);
  var name = $this.attr("value");
  var f = fixesByName[name];
  this.checked = f.enabled;
  $this.click(updateSaveButton);
});

$("#"+ignoredFontsName).text(ignoredFonts.join(", "))
  .change(updateSaveButton);

$("#ok").click(save);
$("#cancel").click(close);
$("#save-default").click(saveDefault);

function save() {
  this.disabled = true;

  google.script.run
          .withSuccessHandler(close)
          .savePreferences();
}

function saveDefault() {
  this.disabled = true;

  defaults = formname();

  google.script.run
          .withSuccessHandler(updateSaveButton)
          .saveDefaults();
}

function close() {
  google.script.host.close();
}

</script>

<script>
//updateSaveButton();

//function saveDefault() {
//  this.disabled = true;
//
//  defaults = formname();
//
//  google.script.run
//          .withSuccessHandler(updateSaveButton)
//          .saveDefaults();
//}
//
//function updateSaveButton() {
//  var button = document.getElementById('save-default');
//  var currentDefault = isDefault();
//
//  button.disabled = currentDefault;
//  button.innerHTML = currentDefault ? 'Saved as default' : 'Set as default';
//}
//
//function isDefault() {
//  $("#prefs input").each(function(index) {
//    var n = $(this);
//    var f = fixesByName[n.attr("value")];
//    if (f.dflt != n.is(":checked")) {
//      return false;
//    }
//  }
//  var current = formname();
//
//  for (var key in defaults) {
//    if (defaults[key] !== current[key]) {
//      return false;
//    }
//  }
//
//  return true;
//}
//
//function formname() {
//  var inputs = form().getElementsByTagName('input');
//
//  var name = {};
//
//  for (var i = 0; i < inputs.length; i++) {
//    var e = inputs[i];
//    name[e.name] = e.checked;
//  }
//  return name;
//}
//
//function form() {
//  return document.getElementById('prefs');
//}
//
//function close() {
//  google.script.host.close();
//}

</script>
