<!-- styles -->
<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<style>
  button.right {
  float: right;
  }
</style>

<!-- content -->
<form id="prefs">
<div class="block">
  <? for (var i = 0; i < fixes.length; i++) { ?>
  <input class="pref" type="checkbox" name="fix" value="<?= key ?>" id="pref-<?= fixes[i].name ?>">
  <label><?= fixes[i].desc ?></label><br>
  <? } ?>
  <textarea class="pref" name="<?= ignoredFontsName ?>" id="<?= ignoredFontsName ?>" rows="3" style="left-indent: 3em; width: 100%"
            onchange="updateSaveButton()"></textarea>
</div>
</form>
<div class="button-bar">
  <button class="action" onclick="save()">OK</button>
  <button onclick="close()">Cancel</button>
</div>
<div class="button-bar-right">
  <button id="save-default" onclick="saveDefault()">Set as default</button>
</div>
<script>alert("aha");</script>

<!-- scripts -->
<script>
console.log("before");
var i = 0;
console.log(i++);
var fixesByName = JSON.parse( <?= JSON.stringify(fixesByName); ?> );
console.log(i++);
$("input.pref").each(function() {
  this.checked = fixByName[$(this).attr("value")].enabled;
});
console.log(i++);
$("#"+ignoredFontsName).value(ignoredFonts.join(", "));
console.log("after");
</script>

<script>
//updateSaveButton();

function save() {
  this.disabled = true;

  google.script.run
          .withSuccessHandler(close)
          .savePreferences();
}

function saveDefault() {
  this.disabled = true;

  defaults = formValue();

  google.script.run
          .withSuccessHandler(updateSaveButton)
          .saveDefaults();
}

function updateSaveButton() {
  var button = document.getElementById('save-default');
  var currentDefault = isDefault();

  button.disabled = currentDefault;
  button.innerHTML = currentDefault ? 'Saved as default' : 'Set as default';
}

function isDefault() {
  $("#prefs input").each(function(index) {
    var n = $(this);
    var f = fixesByName[n.attr("value")];
    if (f.dflt != n.is(":checked")) {
      return false;
    }
  }
  var current = formValue();

  for (var key in defaults) {
    if (defaults[key] !== current[key]) {
      return false;
    }
  }

  return true;
}

function formValue() {
  var inputs = form().getElementsByTagName('input');

  var value = {};

  for (var i = 0; i < inputs.length; i++) {
    var e = inputs[i];
    value[e.value] = e.checked;
  }
  return value;
}

function form() {
  return document.getElementById('prefs');
}

function close() {
  google.script.host.close();
}

</script>
